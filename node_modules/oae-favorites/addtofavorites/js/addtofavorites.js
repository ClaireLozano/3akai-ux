/*!
 * Copyright 2017 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core'], function ($, oae) {

    return function (uid) {

        // The widget container
        var $rootel = $('#' + uid);

        // Variable that will keep track of the current page context
        var contextProfile = null;

        // Variable that will keep track of the resources to delete
        var selectedResources = [];

        /**
         * Reset the state of the widget when the modal dialog has been closed
         */
        var setUpReset = function() {
            $('#addtofavorites-modal').on('hidden.bs.modal', function(ev) {
                // Reset the selected resources
                selectedResources = [];
            });
            $('#addtofavorites-overview-container', $rootel).show();
        };

        /**
         * Render the list of resources to be add to favorites, as well as the action buttons
         *
         * @param  {Object[]}       resources       The array of resources that should be rendered
         */
        var renderOverview = function(resources) {
            oae.api.util.template().render($('#addtofavorites-overview-template', $rootel), {
                'contextProfile': contextProfile,
                'resources': resources
            }, $('#addtofavorites-overview-container', $rootel));
        };

        /**
         * Initialize the favorites resources modal dialog
         */
        var setUpaddtofavoritesModal = function() {
            $(document).on('click', '.oae-trigger-addtofavorites', function() {
                $('#addtofavorites-modal', $rootel).modal({
                    'backdrop': 'static'
                });
                // Get the page context
                $(document).trigger('oae.context.get', 'addtofavorites');
            });

            // Listen to the event that returns the current page context
            $(document).on('oae.context.send.addtofavorites', function(ev, context) {
                contextProfile = context;
                // Get the list selection
                $(document).trigger('oae.list.getSelection', 'addtofavorites');
            });

            // Listen to the event that returns the list of selected resources
            $(document).on('oae.list.sendSelection.addtofavorites', function(ev, selected) {
                selectedResources = selected.results;
                renderOverview(selected.results);
            });

            // Start deleting resources when the user has worked through both the manage and the viewer screens
            $rootel.on('click', '#addtofolder-add', function() {
                var idList = [];
                selectedResources.forEach(function(resource){
                    idList.push(resource.id);
                });
                console.log(idList)
                oae.api.favorites.addToFavorites(contextProfile.id, idList);
            });
        };

        setUpReset();
        setUpaddtofavoritesModal();

    };
});
