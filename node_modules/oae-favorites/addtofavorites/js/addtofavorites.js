/*!
 * Copyright 2017 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core'], function ($, oae) {

    return function (uid) {

        // The widget container
        var $rootel = $('#' + uid);

        // Variable that will keep track of the current page context
        var contextProfile = null;

        // Variable that will keep track of the resources to delete
        var selectedResources = [];

        /**
         * Add the element to the favorites list
         */
        var addToList = function(elements, callback) {
            _.each(elements, function(e) {

                // Create icon 
                var a = document.createElement("a");
                a.className = "fa fa-times-circle pull-right starIcon";
                a.id = e.id;

                // Create elements list 
                var nodeLi = document.createElement("LI"); 
                nodeLi.className = "favoritesLi";
                var link = document.createElement("a");
                var name = "";

                if(e.displayName.length > 18) {
                    name = e.displayName.substring(0,18) + '...';
                } else {
                    name = e.displayName;
                }
                link.appendChild(document.createTextNode(name));
                link.href = e.profilePath;
                link.className = "favoritesLink";

                // Append elements to the list
                nodeLi.appendChild(a);    
                nodeLi.appendChild(link);    

                $("div.oae-lhnavigation > ul > li:nth-last-child(1)").append(nodeLi).fadeIn('slow');
            });
        }

        /**
         * Initialize the favorites resources modal dialog
         */
        var setUpaddtofavorites = function() {
            $(document).on('click', '.oae-trigger-addtofavorites', function() {
                // Get the page context
                $(document).trigger('oae.context.get', 'addtofavorites');
            });

            // Listen to the event that returns the current page context
            $(document).on('oae.context.send.addtofavorites', function(ev, context) {
                contextProfile = context;
                // Get the list selection
                $(document).trigger('oae.list.getSelection', 'addtofavorites');
            });

            // Listen to the event that returns the list of selected resources
            $(document).on('oae.list.sendSelection.addtofavorites', function(ev, selected) {

                selectedResources = [];
                selectedResources = selected.results;

                var idList = [];
                selectedResources.forEach(function(resource){
                    idList.push(resource.id);
                });

                oae.api.favorites.addToFavorites(contextProfile.id, idList, function(err, elements) {
                    if(err) {
                        // Show a generic failure notification
                        oae.api.util.notification(
                            oae.api.i18n.translate('__MSG__ADD_TO_FAVORITES_FAILED__'),
                            oae.api.i18n.translate('__MSG__YOU_HAVE_ALREADY_THIS_DOC_IN_FAVORITES__', 'preferences'),
                            'error'
                        );
                    } else {
                        // Show a success notification
                        oae.api.util.notification(
                            oae.api.i18n.translate('__MSG__ADD_TO_FAVORITES_SUCCESSED__', 'preferences'),
                            oae.api.i18n.translate('__MSG__YOUR_RESOURCES_IS_ADDED_TO_YOUR_FAVORITES__', 'preferences')
                        );

                        // Add the new element to the list
                        addToList(elements, function(err){
                            if(err) {
                                return err;
                            }
                        });
                    }
                    return null;
                });
            });
        };

        setUpaddtofavorites();

    };
});
