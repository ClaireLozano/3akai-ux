/*!
 * Copyright 2014 Apereo Foundation (AF) Licensed under the
 * Educational Community License, Version 2.0 (the "License"); you may
 * not use this file except in compliance with the License. You may
 * obtain a copy of the License at
 *
 *     http://opensource.org/licenses/ECL-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an "AS IS"
 * BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express
 * or implied. See the License for the specific language governing
 * permissions and limitations under the License.
 */

define(['jquery', 'oae.core', 'jquery.history'], function($, oae) {

    return function(uid) {

        // The widget container
        var $rootel = $('#' + uid);

        var getFavoritesLibrary = function() {
            oae.api.favorites.getFavoritesLibrary(oae.data.me.id, function(err, data) {
                appendFavorites(data.results);
            });
        };

        var deleteFavoritesToLibrary = function(id) {
            var element = document.getElementById(id);

            while (element.parentNode.hasChildNodes()) {
                element.parentNode.removeChild(element.parentNode.lastChild);
            }

        };

        var appendFavorites = function(element) {
            // Create new li 
            var nodeLiFavorites = document.createElement("LI"); 

            // Create list
            var nodeUl = document.createElement("UL"); 
            nodeUl.className = "list-unstyled";
            nodeUl.id = "favoritesUl";

            _.each(element, function(e) {

                // Create elements list 
                var nodeLi = document.createElement("LI"); 
                nodeLi.className = "favoritesLi";

                var link = document.createElement("a");
                var name = "";

                if(e.displayName.length > 18) {
                    name = e.displayName.substring(0,18) + '...';
                } else {
                    name = e.displayName;
                }
                link.appendChild(document.createTextNode(name));
                link.href = e.profilePath;
                link.className = "favoritesLink";

                // Create icon 
                var a = document.createElement("a");
                a.className = "fa fa-times pull-right starIcon";
                a.id = e.id;

                // Append elements to the list
                nodeLi.appendChild(a);
                nodeLi.appendChild(link); 
                nodeUl.appendChild(nodeLi);   
            }); 

            // Create horizontal line
            var hr = document.createElement('hr');

            // Append elements to the DOM
            $("div.oae-lhnavigation > ul").append(nodeLiFavorites);
            $("div.oae-lhnavigation > ul > li:nth-last-child(1)").append(hr);
            $("div.oae-lhnavigation > ul > li:nth-last-child(1)").append(nodeUl);
        }; 

        var bindFavoritesListeners = function() {

            $(document).on('click','.starIcon',function(e){
                var id = this.id;

                // Remove the element to the favorites table 
                oae.api.favorites.removeFromFavorites(oae.data.me.id, id, function(err, elements) {
                    if(err) {
                        // Show a generic failure notification
                        oae.api.util.notification(
                            oae.api.i18n.translate('__MSG__REMOVE_TO_FAVORITES_FAILED__'),
                            oae.api.i18n.translate('__MSG__ERROR__', 'preferences'),
                            'error'
                        );
                    } else {
                        // Show a success notification
                        oae.api.util.notification(
                            oae.api.i18n.translate('__MSG__REMOVE_TO_FAVORITES_SUCCESSED__', 'preferences'),
                            oae.api.i18n.translate('__MSG__REMOVED_FAVORITES_SUCCESSED__', 'preferences')
                        );

                        // Delete element to the list
                        deleteFavoritesToLibrary(id);
                    }
                });
            });

            // Change the icon when mouse hover
            /*$(document).on('mouseleave','.starIcon',function(e) {
                $(this).removeClass('fa-trash-o');
                $(this).addClass('fa-star');
            });

            $(document).on('mouseenter','.starIcon',function(e) {
                $(this).removeClass('fa-star');
                $(this).addClass('fa-trash-o');
            });*/
        }; 
        
        getFavoritesLibrary();
        bindFavoritesListeners();

    };
});
